<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Joseph Wong</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">

    <!-- Important to preload offline icons as they can't be fetched when the server is offline lol -->
    <link rel="preload" href="/static/icons/online-light.png" as="image">
    <link rel="preload" href="/static/icons/online-dark.png" as="image">
    <link rel="preload" href="/static/icons/offline-light.png" as="image">
    <link rel="preload" href="/static/icons/offline-dark.png" as="image">
</head>

<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">Joseph Wong - Personal Website</div>
        <div class="nav-center">
            <a href="/server" class="uptime-link">
                <span class="uptime-left">
                    <img id="uptime-icon" class="uptime-icon" alt="status">
                    <span class="uptime-label">Uptime:</span>
                </span>
                <span class="uptime-value" id="uptime-value">Fetching uptime...</span>
            </a>
        </div>
        <div class="nav-right">
            <div class="nav-item">
                <a>Other Services</a>
                <div class="dropdown">
                    <a href="#placeholder2a">Option A</a>
                    <a href="#placeholder2b">Option B</a>
                </div>
            </div>
            <div class="nav-item">
                <a>Settings</a>
                <div class="dropdown">
                    <a href="#placeholder3a">Option A</a>
                    <a href="#placeholder3b">Option B</a>
                </div>
            </div>
            <div class="nav-item">
                <a>Register / Log In</a>
                <div class="dropdown">
                    <a href="#placeholder4a">Log In</a>
                    <a href="#placeholder4b">Register</a>
                </div>
            </div>
        </div>        
    </nav>

    <!-- Main Content Area -->
    <!-- Reads from a markdown file in /src/app/content/ -->
    <main class="content">
        {{ page_content|safe }}
    </main>
    
    <!-- Footer / Bottom Section -->
    <footer class="footer">
        <p>&copy; 2025 Joseph Wong. Site served from a Raspberry Pi.</p>
    </footer>

    <script>
        function formatUptime(seconds) {
            const units = [
                ["y", 31536000],
                ["d", 86400],
                ["h", 3600],
                ["m", 60],
                ["s", 1]
            ];
            let result = [];
            for (const [name, value] of units) {
                const count = Math.floor(seconds / value);
                if (count > 0 || result.length) {
                    result.push(`${count}${name}`);
                    seconds %= value;
                }
                if (result.length === 2) break;
            }
            return result.length ? result.join(" ") : "0s";
        }
    
        const isDarkMode = () => window.matchMedia('(prefers-color-scheme: dark)').matches;
    
        function getIconPath(status) {
            const mode = isDarkMode() ? "dark" : "light";
            return `/static/icons/${status}-${mode}.png`;
        }
    
        const uptime = {
            iconEl: document.getElementById("uptime-icon"),
            valueEl: document.getElementById("uptime-value"),
            serverReachable: false,
            seconds: null,
    
            init: async function () {
                try {
                    const res = await fetch("/api/uptime", { cache: "no-store" });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    this.seconds = data.uptime_seconds;
                    this.serverReachable = true;
                } catch {
                    this.serverReachable = false;
                }
                this.updateDisplay();
            },
    
            tick: function () {
                if (this.serverReachable && this.seconds !== null) {
                    this.seconds++;
                    this.updateDisplay();
                }
            },
    
            markOffline: function () {
                if (this.serverReachable) {
                    this.serverReachable = false;
                    this.updateDisplay();
                }
            },
    
            updateDisplay: function () {
                const status = (this.serverReachable && this.seconds !== null) ? "online" : "offline";
                this.iconEl.src = getIconPath(status);
    
                if (this.serverReachable && this.seconds !== null) {
                    this.valueEl.textContent = ` ${formatUptime(this.seconds)}`;
                    this.valueEl.classList.remove("unreachable");
                } else {
                    this.valueEl.textContent = "Server unreachable";
                    this.valueEl.classList.add("unreachable");
                }
            }
        };
    
        async function apiFetch(url, options = {}) {
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error();
                return await res.json();
            } catch (err) {
                uptime.markOffline();
                throw err;
            }
        }
    
        // Initialize uptime tracking on page load
        uptime.init();
        setInterval(() => uptime.tick(), 1000);
    
        // Recalculate icon if theme changes
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
            uptime.updateDisplay();
        });
    
        // NEW: Re-fetch uptime when tab regains focus
        window.addEventListener("focus", async () => {
            await uptime.init();
        });
    </script>

</body>
</html>
